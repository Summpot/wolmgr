# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Deploy (Cloudflare Pages + Turso)

on:
  push:
    branches:
      - main
    paths:
      - src/**
      - public/**
      - package.json
      - pnpm-lock.yaml
      - rsbuild.config.ts
      - rslib.config.ts
      - tsconfig.json
      - wrangler.json
      - Dockerfile
      - .github/workflows/deploy-cloudflare.yml
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: cloudflare-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy wolmgr
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Resolve Cloudflare config (Pages)
        id: cfg
        shell: bash
        run: |
          set -euo pipefail

          node <<'NODE'
          const fs = require('node:fs');

          const wranglerPath = 'wrangler.json';
          const cfg = JSON.parse(fs.readFileSync(wranglerPath, 'utf8'));

          const projectName = String(cfg?.name ?? '').trim();
          if (!projectName) {
            throw new Error('Could not resolve Pages project name from wrangler.json (expected: { "name": "..." })');
          }

          const compatibilityDate = String(cfg?.compatibility_date ?? '').trim();

          fs.appendFileSync(
            process.env.GITHUB_OUTPUT,
            [
              `pages_project=${projectName}`,
              `compatibility_date=${compatibilityDate}`,
              `wrangler_base_config=${wranglerPath}`,
              `wrangler_pages_config=${wranglerPath}`,
              '',
            ].join('\n'),
          );

          console.log(`Pages project: ${projectName}`);
          console.log(`Wrangler config: ${wranglerPath}`);
          NODE

      - name: Ensure Pages project exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PAGES_PROJECT: ${{ steps.cfg.outputs.pages_project }}
          COMPATIBILITY_DATE: ${{ steps.cfg.outputs.compatibility_date }}
          WRANGLER_BASE_CONFIG: ${{ steps.cfg.outputs.wrangler_base_config }}
        shell: bash
        run: |
          set -euo pipefail

          project="${PAGES_PROJECT:?PAGES_PROJECT is required}"
          compat="${COMPATIBILITY_DATE:-}"
          config="${WRANGLER_BASE_CONFIG:?WRANGLER_BASE_CONFIG is required}"
          account="${CLOUDFLARE_ACCOUNT_ID:?CLOUDFLARE_ACCOUNT_ID is required}"

          echo "Ensuring Pages project '$project' exists (errors are safe to ignore):"

          cmd=(pnpm exec wrangler pages project create "$project" --production-branch "main" --config "$config")
          if [ -n "$compat" ]; then
            cmd+=(--compatibility-date "$compat")
          fi

          "${cmd[@]}" || true

      - name: Ensure Turso database exists (Platform API)
        id: turso
        env:
          TURSO_PLATFORM_API_TOKEN: ${{ secrets['TURSO_PLATFORM_API_TOKEN'] }}
          TURSO_ORG_SLUG: ${{ secrets['TURSO_ORG_SLUG'] }}
          TURSO_DB_NAME: ${{ secrets['TURSO_DB_NAME'] }}
          TURSO_GROUP: ${{ secrets['TURSO_GROUP'] }}
        shell: bash
        run: |
          set -euo pipefail

          node --input-type=module <<'NODE'
          import fs from 'node:fs';

          const org = String(process.env.TURSO_ORG_SLUG ?? '').trim();
          const name = String(process.env.TURSO_DB_NAME ?? '').trim();
          const group = String(process.env.TURSO_GROUP ?? 'default').trim() || 'default';
          const token = String(process.env.TURSO_PLATFORM_API_TOKEN ?? '').trim();

          if (!org) throw new Error('Missing TURSO_ORG_SLUG');
          if (!name) throw new Error('Missing TURSO_DB_NAME');
          if (!token) throw new Error('Missing TURSO_PLATFORM_API_TOKEN');

          async function api(path, init = {}) {
            const res = await fetch(`https://api.turso.tech${path}`, {
              ...init,
              headers: {
                Authorization: `Bearer ${token}`,
                ...(init.headers ?? {}),
              },
            });
            const text = await res.text();
            const json = text ? JSON.parse(text) : null;
            if (!res.ok) {
              const err = new Error(`Turso API ${res.status} ${res.statusText} on ${path}`);
              err.details = json;
              throw err;
            }
            return json;
          }

          // Create DB if missing.
          const list = await api(`/v1/organizations/${encodeURIComponent(org)}/databases`);
          const databases = Array.isArray(list?.databases) ? list.databases : [];
          const exists = databases.some((db) => String(db?.Name ?? '').trim() === name);

          if (!exists) {
            try {
              await api(`/v1/organizations/${encodeURIComponent(org)}/databases`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, group }),
              });
            } catch (err) {
              // Concurrent create can happen; allow it to proceed.
              const status = String(err?.details?.error ?? '');
              if (!String(err.message ?? '').includes('409') && !status.toLowerCase().includes('already')) {
                throw err;
              }
            }
          }

          // Retrieve Hostname.
          const db = await api(`/v1/organizations/${encodeURIComponent(org)}/databases/${encodeURIComponent(name)}`);
          const hostname = String(db?.database?.Hostname ?? '').trim();
          if (!hostname) throw new Error('Turso API: missing database.Hostname');
          const databaseUrl = `https://${hostname}`;

          // Create a database auth token.
          const tok = await api(`/v1/organizations/${encodeURIComponent(org)}/databases/${encodeURIComponent(name)}/auth/tokens?authorization=full-access`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}),
          });
          const jwt = String(tok?.jwt ?? '').trim();
          if (!jwt) throw new Error('Turso API: missing jwt');

          console.log(`::add-mask::${jwt}`);

          fs.appendFileSync(
            process.env.GITHUB_OUTPUT,
            [`turso_database_url=${databaseUrl}`, `turso_auth_token=${jwt}`, ''].join('\n'),
          );

          console.log(`Turso database ensured: ${name} (${databaseUrl})`);
          NODE

      - name: Configure Pages secrets (Turso)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PAGES_PROJECT: ${{ steps.cfg.outputs.pages_project }}
          TURSO_DATABASE_URL: ${{ steps.turso.outputs.turso_database_url }}
          TURSO_AUTH_TOKEN: ${{ steps.turso.outputs.turso_auth_token }}
        shell: bash
        run: |
          set -euo pipefail

          project="${PAGES_PROJECT:?PAGES_PROJECT is required}"

          printf "%s" "$TURSO_DATABASE_URL" | pnpm exec wrangler pages secret put TURSO_DATABASE_URL --project-name "$project"
          printf "%s" "$TURSO_AUTH_TOKEN" | pnpm exec wrangler pages secret put TURSO_AUTH_TOKEN --project-name "$project"

      - name: Build (UI + Pages _worker.js)
        run: pnpm build

      - name: Deploy (Pages)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          WRANGLER_PAGES_CONFIG: ${{ steps.cfg.outputs.wrangler_pages_config }}
          WRANGLER_CONFIG: ${{ steps.cfg.outputs.wrangler_pages_config }}
        shell: bash
        run: |
          set -euo pipefail

          project="${{ steps.cfg.outputs.pages_project }}"
          pnpm exec wrangler pages deploy dist \
            --project-name "$project" \
            --branch "main" \
            --experimental-provision \
            --experimental-auto-create

      - name: Summary
        shell: bash
        run: |
          {
            echo "## Cloudflare deploy"
            echo ""
            echo "- Pages project: ${{ steps.cfg.outputs.pages_project }}"
            echo "- Data store: Turso (libSQL)"
          } >> "$GITHUB_STEP_SUMMARY"
